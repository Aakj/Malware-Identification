#!/usr/bin/env python
# coding: utf-8

import sys
import os
import pickle
import csv
import numpy as np
#from sklearn.feature_extraction.text import TfidfVectorizer
#from sklearn.tree import DecisionTreeClassifier 
#from sklearn.metrics import accuracy_score 
#from mlxtend.classifier import EnsembleVoteClassifier
#from sklearn.model_selection import KFold
#from sklearn.model_selection import train_test_split

features = {'e_cblp:':0,'e_cp:':1,'e_cparhdr:':2,'e_maxalloc:':3,'e_sp:':4,'e_lfanew:':5,'Machine:':6,
            'NumberOfSections:':7,'SizeOfOptionalHeader:':8,'MajorLinkerVersion:':9,'MinorLinkerVersion:':10,'SizeOfCode:':11,
           'SizeOfInitializedData:':12,'SizeOfUninitializedData:':13,'AddressOfEntryPoint:':14,
            'BaseOfCode:':15,'BaseOfData:':16,'ImageBase:':17,'SectionAlignment:':18,'FileAlignment:':19,
           'MajorOperatingSystemVersion:':20,'MinorOperatingSystemVersion:':21,'MajorImageVersion:':22,
            'MinorImageVersion:':23,'MajorSubsystemVersion:':24,'MinorSubsystemVersion:':25,'SizeOfImage:':26,
           'SizeOfHeaders:':27,'CheckSum:':28,'Subsystem:':29,'DllCharacteristics:':30,'SizeOfStackReserve:':31,
            'SizeOfStackCommit:':32,'SizeOfHeapReserve:':33,'SizeOfHeapCommit:':34,'LoaderFlags:':35,
            'NumberOfRvaAndSizes:':36}

reduced_apis = ['0exception', '1type_info', '__cxxframehandler', '__cxxframehandler3', '__dllonexit', '__getmainargs', '__initenv', '__p__commode', '__p__environ', '__p__fmode', '__set_app_type', '__setusermatherr', '__vbaaryconstruct2', '__vbaarydestruct', '__vbaarylock', '__vbaaryunlock', '__vbaboolvar', '__vbaboolvarnull', '__vbacastobj', '__vbacastobjvar', '__vbachkstk', '__vbaend', '__vbaerroroverflow', '__vbaexcepthandler', '__vbaexitproc', '__vbafileclose', '__vbafileopen', '__vbafpexception', '__vbafpi2', '__vbafpi4', '__vbafpr8', '__vbafreeobj', '__vbafreeobjlist', '__vbafreestr', '__vbafreestrlist', '__vbafreevar', '__vbafreevarlist', '__vbagenerateboundserror', '__vbahresultcheckobj', '__vbai2i4', '__vbai2str', '__vbai2var', '__vbai4str', '__vbai4var', '__vbainstr', '__vbainstrvar', '__vbalateidcall', '__vbalateidcallld', '__vbalateidst', '__vbalatememcall', '__vbalatememcallld', '__vbalatememst', '__vbalenbstr', '__vbalenvar', '__vbalsetfixstr', '__vbanew', '__vbanew2', '__vbaobjis', '__vbaobjset', '__vbaobjsetaddref', '__vbaobjvar', '__vbaonerror', '__vbaprintfile', '__vbar4var', '__vbar8str', '__vbaredim', '__vbaredimpreserve', '__vbasetsystemerror', '__vbastrcat', '__vbastrcmp', '__vbastrcopy', '__vbastrerrvarcopy', '__vbastri2', '__vbastri4', '__vbastrmove', '__vbastrr8', '__vbastrtoansi', '__vbastrtounicode', '__vbastrvarcopy', '__vbastrvarmove', '__vbastrvarval', '__vbaubound', '__vbavaradd', '__vbavarand', '__vbavarcat', '__vbavarcmpeq', '__vbavarcmpne', '__vbavarcopy', '__vbavardiv', '__vbavardup', '__vbavarforinit', '__vbavarfornext', '__vbavarindexload', '__vbavarlatememcallld', '__vbavarlatememst', '__vbavarmove', '__vbavarmul', '__vbavaror', '__vbavarsub', '__vbavartsteq', '__vbavartstgt', '__vbavartstlt', '__vbavartstne', '__vbavarvargnofree', '__wgetmainargs', '__wsafdisset', '_acmdln', '_adj_fdiv_m16i', '_adj_fdiv_m32', '_adj_fdiv_m32i', '_adj_fdiv_m64', '_adj_fdiv_r', '_adj_fdivr_m16i', '_adj_fdivr_m32', '_adj_fdivr_m32i', '_adj_fdivr_m64', '_adj_fpatan', '_adj_fprem', '_adj_fprem1', '_adj_fptan', '_adjust_fdiv', '_allmul', '_amsg_exit', '_beginthreadex', '_c_exit', '_cexit', '_ciatan', '_cicos', '_ciexp', '_cilog', '_cisin', '_cisqrt', '_citan', '_close', '_controlfp', '_corexemain', '_cxxthrowexception', '_errno', '_except_handler3', '_except_handler4_common', '_exit', '_initterm', '_iob', '_ismbblead', '_lclose', '_lcreat', '_llseek', '_lock', '_lopen', '_lread', '_lwrite', '_onexit', '_open', '_purecall', '_read', '_setmode', '_snprintf', '_strdup', '_stricmp', '_strnicmp', '_trackmouseevent', '_unlock', '_vsnprintf', '_vsnwprintf', '_w', '_wcmdln', '_wcsicmp', '_wcsnicmp', '_write', '_wtoi', '_wtol', '_wu', '_xcptfilter', 'abort', 'abortdoc', 'abv0', 'abv01', 'accept', 'activatekeyboardlayout', 'addaccessallowedace', 'adjusttokenprivileges', 'adjustwindowrectex', 'allocateandinitializesid', 'allocator', 'alphablend', 'appendmenua', 'appendmenuw', 'arc', 'arefileapisansi', 'argument_lexemizer', 'atexit', 'atoi', 'attachthreadinput', 'av', 'basic_string', 'begindeferwindowpos', 'beginpaint', 'bind', 'bitblt', 'bringwindowtotop', 'callnexthookex', 'calloc', 'callwindowproca', 'callwindowprocw', 'certclosestore', 'certenumcertificatesinstore', 'certfindcertificateinstore', 'certfreecertificatechain', 'certfreecertificatecontext', 'certgetcertificatechain', 'certgetcertificatecontextproperty', 'certgetintendedkeyusage', 'certgetnamestringw', 'certopenstore', 'changeserviceconfigw', 'char_traits', 'charlowera', 'charlowerbuffa', 'charlowerbuffw', 'charlowerw', 'charnexta', 'charnextw', 'charpreva', 'charprevw', 'chartooema', 'chartooembuffa', 'charuppera', 'charupperbuffa', 'charupperbuffw', 'charupperw', 'checkdlgbutton', 'checkmenuitem', 'checkradiobutton', 'checktokenmembership', 'childwindowfrompoint', 'choosecolora', 'chord', 'chstring', 'classinfobase', 'clienttoscreen', 'closeclipboard', 'closehandle', 'closeservicehandle', 'closesocket', 'clsidfromprogid', 'clsidfromstring', 'cm_get_device_idw', 'cm_get_devnode_status', 'cm_get_parent', 'cocreateguid', 'cocreateinstance', 'codisconnectobject', 'cofreeunusedlibraries', 'cogetclassobject', 'coinitialize', 'coinitializeex', 'coinitializesecurity', 'colockobjectexternal', 'combinergn', 'commandlinetoargvw', 'commdlgextendederror', 'comparefiletime', 'comparestringa', 'comparestringw', 'connect', 'connectnamedpipe', 'controlservice', 'convertdefaultlocale', 'convertsidtostringsidw', 'convertstringsecuritydescriptortosecuritydescriptorw', 'copyacceleratortablew', 'copyenhmetafilea', 'copyfilea', 'copyfileexw', 'copyfilew', 'copyicon', 'copyimage', 'copymetafilew', 'copyrect', 'copysid', 'coregisterclassobject', 'coregistermessagefilter', 'corevokeclassobject', 'cosetproxyblanket', 'cotaskmemalloc', 'cotaskmemfree', 'cotaskmemrealloc', 'couninitialize', 'createacceleratortablew', 'createbitmap', 'createbrushindirect', 'createcaret', 'createcompatiblebitmap', 'createcompatibledc', 'createdca', 'createdcw', 'createdialogindirectparama', 'createdialogindirectparamw', 'createdialogparama', 'createdialogparamw', 'createdibitmap', 'createdibsection', 'createdirectorya', 'createdirectoryw', 'createenvironmentblock', 'createerrorinfo', 'createeventa', 'createeventw', 'createfilea', 'createfilemappinga', 'createfilemappingw', 'createfilew', 'createfonta', 'createfontindirecta', 'createfontindirectw', 'createfontw', 'createhalftonepalette', 'createicon', 'createiconindirect', 'createilockbytesonhglobal', 'createiocompletionport', 'createmenu', 'createmutexa', 'createmutexw', 'createnamedpipea', 'createnamedpipew', 'createpalette', 'createpatternbrush', 'createpen', 'createpenindirect', 'createpipe', 'createpolygonrgn', 'createpopupmenu', 'createprocessa', 'createprocessw', 'createrectrgn', 'createrectrgnindirect', 'createroundrectrgn', 'createsemaphorea', 'createsemaphorew', 'createsolidbrush', 'createstdaccessibleobject', 'createstreamonhglobal', 'createthread', 'createtoolhelp32snapshot', 'createwellknownsid', 'createwindowexa', 'createwindowexw', 'cryptacquirecontexta', 'cryptacquirecontextw', 'cryptcatadmincalchashfromfilehandle', 'cryptcreatehash', 'cryptdecryptmessage', 'cryptdestroyhash', 'cryptdestroykey', 'cryptencryptmessage', 'cryptgenrandom', 'cryptgethashparam', 'crypthashdata', 'crypthashpublickeyinfo', 'cryptmsgclose', 'cryptmsggetparam', 'cryptqueryobject', 'cryptreleasecontext', 'cryptuidlgviewcertificatew', 'cryptunprotectdata', 'debugbreak', 'decodepointer', 'decryptfilew', 'deferwindowpos', 'defframeproca', 'defframeprocw', 'defmdichildproca', 'defmdichildprocw', 'defwindowproca', 'defwindowprocw', 'deletecriticalsection', 'deletedc', 'deleteenhmetafile', 'deletefilea', 'deletefilew', 'deletemenu', 'deleteobject', 'deleteservice', 'deregistereventsource', 'destroyacceleratortable', 'destroycursor', 'destroyicon', 'destroymenu', 'destroywindow', 'deviceiocontrol', 'dialogboxindirectparama', 'dialogboxindirectparamw', 'dialogboxparama', 'dialogboxparamw', 'directui', 'dispatchmessagea', 'dispatchmessagew', 'dllfunctioncall', 'dodragdrop', 'dosdatetimetofiletime', 'dptolp', 'dragacceptfiles', 'dragfinish', 'dragqueryfilea', 'dragqueryfilew', 'drawanimatedrects', 'drawedge', 'drawfocusrect', 'drawframecontrol', 'drawicon', 'drawiconex', 'drawmenubar', 'drawstatew', 'drawtexta', 'drawtextexw', 'drawtextw', 'du', 'duilib', 'duplicatehandle', 'element', 'ellipse', 'emptyclipboard', 'enablemenuitem', 'enablescrollbar', 'enablewindow', 'encodepointer', 'enddeferwindowpos', 'enddialog', 'enddoc', 'endpage', 'endpaint', 'entercriticalsection', 'enumcalendarinfoa', 'enumcalendarinfow', 'enumchildwindows', 'enumclipboardformats', 'enumdisplaymonitors', 'enumfontfamiliesexa', 'enumfontfamiliesexw', 'enumfontsa', 'enumresourcelanguagesw', 'enumsystemlocalesa', 'enumsystemlocalesw', 'enumthreadwindows', 'enumwindows', 'equalrect', 'equalsid', 'escape', 'event_sink_addref', 'event_sink_queryinterface', 'event_sink_release', 'excludecliprect', 'exit', 'exitprocess', 'exitthread', 'exitwindowsex', 'expandenvironmentstringsa', 'expandenvironmentstringsw', 'extcreatepen', 'extfloodfill', 'extracticonw', 'extselectcliprgn', 'exttextouta', 'exttextoutw', 'fatalappexita', 'fclose', 'fflush', 'filetimetodosdatetime', 'filetimetolocalfiletime', 'filetimetosystemtime', 'fillrect', 'fillrgn', 'findclose', 'findclosechangenotification', 'findfirstchangenotificationw', 'findfirstfilea', 'findfirstfileexa', 'findfirstfileexw', 'findfirstfilew', 'findnextchangenotification', 'findnextfilea', 'findnextfilew', 'findresourcea', 'findresourceexa', 'findresourceexw', 'findresourcew', 'findwindowa', 'findwindowexa', 'findwindowexw', 'findwindoww', 'flatsb_setscrollinfo', 'flushfilebuffers', 'flushinstructioncache', 'fopen', 'formatmessagea', 'formatmessagew', 'fprintf', 'fputc', 'fputs', 'framerect', 'framergn', 'fread', 'free', 'freeaddrinfo', 'freeconsole', 'freeenvironmentstringsa', 'freeenvironmentstringsw', 'freelibrary', 'freelibraryandexitthread', 'freeresource', 'freesid', 'fwrite', 'gdiflush', 'gdipalloc', 'gdipbitmaplockbits', 'gdipbitmapunlockbits', 'gdipcloneimage', 'gdipcreatebitmapfromhbitmap', 'gdipcreatebitmapfromscan0', 'gdipcreatebitmapfromstream', 'gdipcreatefromhdc', 'gdipcreatesolidfill', 'gdipdeletebrush', 'gdipdeletegraphics', 'gdipdisposeimage', 'gdipdrawimagei', 'gdipdrawimagerecti', 'gdipfree', 'gdipgetimagegraphicscontext', 'gdipgetimageheight', 'gdipgetimagepixelformat', 'gdipgetimagewidth', 'gdiplusshutdown', 'gdiplusstartup', 'gdipsetinterpolationmode', 'getace', 'getacp', 'getactiveobject', 'getactivewindow', 'getaddrinfo', 'getasynckeystate', 'getbitmapbits', 'getbkcolor', 'getbkmode', 'getbrushorgex', 'getcapture', 'getcharwidthw', 'getclassinfoa', 'getclassinfoexw', 'getclassinfow', 'getclasslonga', 'getclasslongw', 'getclassnamea', 'getclassnamew', 'getclientrect', 'getclipboarddata', 'getclipbox', 'getcliprgn', 'getcomboboxinfo', 'getcommandlinea', 'getcommandlinew', 'getcomputernamea', 'getcomputernamew', 'getconsolecp', 'getconsolemode', 'getconsoleoutputcp', 'getconsolescreenbufferinfo', 'getcpinfo', 'getcurrentdirectorya', 'getcurrentdirectoryw', 'getcurrentobject', 'getcurrentpositionex', 'getcurrentprocess', 'getcurrentprocessid', 'getcurrentthread', 'getcurrentthreadid', 'getcursor', 'getcursorpos', 'getdateformata', 'getdateformatw', 'getdc', 'getdcex', 'getdcorgex', 'getdesktopwindow', 'getdevicecaps', 'getdialogbaseunits', 'getdibcolortable', 'getdibits', 'getdiskfreespacea', 'getdiskfreespaceexw', 'getdiskfreespacew', 'getdlgctrlid', 'getdlgitem', 'getdlgitemtexta', 'getdlgitemtextw', 'getdoubleclicktime', 'getdrivetypea', 'getdrivetypew', 'getenhmetafilebits', 'getenhmetafileheader', 'getenhmetafilepaletteentries', 'getenv', 'getenvironmentstrings', 'getenvironmentstringsw', 'getenvironmentvariablea', 'getenvironmentvariablew', 'geterrorinfo', 'getexitcodeprocess', 'getexitcodethread', 'getfileattributesa', 'getfileattributesexw', 'getfileattributesw', 'getfileinformationbyhandle', 'getfilesecurityw', 'getfilesize', 'getfilesizeex', 'getfiletime', 'getfiletitlea', 'getfiletitlew', 'getfiletype', 'getfileversioninfoa', 'getfileversioninfosizea', 'getfileversioninfosizew', 'getfileversioninfow', 'getfocus', 'getforegroundwindow', 'getfullpathnamea', 'getfullpathnamew', 'gethostbyaddr', 'gethostbyname', 'gethostname', 'geticoninfo', 'getkeyboardlayout', 'getkeyboardlayoutlist', 'getkeyboardlayoutnamea', 'getkeyboardlayoutnamew', 'getkeyboardstate', 'getkeyboardtype', 'getkeynametexta', 'getkeynametextw', 'getkeystate', 'getlastactivepopup', 'getlasterror', 'getlayout', 'getlengthsid', 'getlocaleinfoa', 'getlocaleinfow', 'getlocaltime', 'getlogicaldrives', 'getlogicaldrivestringsw', 'getlongpathnamew', 'getmapmode', 'getmappedfilenamea', 'getmenu', 'getmenucheckmarkdimensions', 'getmenuitemcount', 'getmenuitemid', 'getmenuiteminfoa', 'getmenuiteminfow', 'getmenustate', 'getmenustringa', 'getmenustringw', 'getmessagea', 'getmessagepos', 'getmessagetime', 'getmessagew', 'getmodulefilenamea', 'getmodulefilenamew', 'getmodulehandlea', 'getmodulehandleexw', 'getmodulehandlew', 'getmonitorinfow', 'getnativesysteminfo', 'getnearestpaletteindex', 'getnextdlggroupitem', 'getnextdlgtabitem', 'getnumberformatw', 'getobjecta', 'getobjecttype', 'getobjectw', 'getoemcp', 'getopenfilenamea', 'getopenfilenamew', 'getoverlappedresult', 'getpaletteentries', 'getparent', 'getpeername', 'getpixel', 'getprivateprofileinta', 'getprivateprofileintw', 'getprivateprofilestringa', 'getprivateprofilestringw', 'getprocaddress', 'getprocessaffinitymask', 'getprocessheap', 'getprocessid', 'getprocesstimes', 'getprofileintw', 'getprofilestringa', 'getpropa', 'getpropw', 'getrgnbox', 'getrunningobjecttable', 'getsavefilenamea', 'getsavefilenamew', 'getscrollinfo', 'getscrollpos', 'getscrollrange', 'getsecuritydescriptordacl', 'getshortpathnamea', 'getshortpathnamew', 'getsidlengthrequired', 'getsidsubauthority', 'getsockname', 'getsockopt', 'getstartupinfoa', 'getstartupinfow', 'getstdhandle', 'getstockobject', 'getstringtypea', 'getstringtypeexa', 'getstringtypeexw', 'getstringtypew', 'getsubmenu', 'getsyscolor', 'getsyscolorbrush', 'getsystemdefaultlangid', 'getsystemdefaultlcid', 'getsystemdefaultuilanguage', 'getsystemdirectorya', 'getsystemdirectoryw', 'getsysteminfo', 'getsystemmenu', 'getsystemmetrics', 'getsystempaletteentries', 'getsystemtime', 'getsystemtimeasfiletime', 'getsystemwow64directoryw', 'gettempfilenamea', 'gettempfilenamew', 'gettemppatha', 'gettemppathw', 'gettextcolor', 'gettextextentpoint32a', 'gettextextentpoint32w', 'gettextextentpointa', 'gettextextentpointw', 'gettextfacew', 'gettextmetricsa', 'gettextmetricsw', 'getthreadcontext', 'getthreadlocale', 'getthreadpriority', 'getthreadtimes', 'gettickcount', 'gettimeformata', 'gettimeformatw', 'gettimezoneinformation', 'gettokeninformation', 'gettopwindow', 'gettraceenableflags', 'gettraceenablelevel', 'gettraceloggerhandle', 'getupdaterect', 'getuserdefaultlangid', 'getuserdefaultlcid', 'getuserdefaultuilanguage', 'getusernamea', 'getusernameexw', 'getusernamew', 'getversion', 'getversionexa', 'getversionexw', 'getviewportextex', 'getviewportorgex', 'getvolumeinformationa', 'getvolumeinformationw', 'getvolumepathnamew', 'getwindow', 'getwindowdc', 'getwindowextex', 'getwindowlonga', 'getwindowlongw', 'getwindoworgex', 'getwindowplacement', 'getwindowrect', 'getwindowrgn', 'getwindowsdirectorya', 'getwindowsdirectoryw', 'getwindowtexta', 'getwindowtextlengtha', 'getwindowtextlengthw', 'getwindowtextw', 'getwindowthreadprocessid', 'getwinmetafilebits', 'globaladdatoma', 'globaladdatomw', 'globalalloc', 'globaldeleteatom', 'globalfindatoma', 'globalfindatomw', 'globalflags', 'globalfree', 'globalgetatomnamea', 'globalgetatomnamew', 'globalhandle', 'globallock', 'globalmemorystatus', 'globalmemorystatusex', 'globalrealloc', 'globalsize', 'globalunlock', 'gradientfill', 'graystringw', 'gu', 'heapalloc', 'heapcreate', 'heapdestroy', 'heapfree', 'heaprealloc', 'heapsetinformation', 'heapsize', 'hidecaret', 'htonl', 'htons', 'httpaddrequestheadersw', 'httpopenrequesta', 'httpopenrequestw', 'httpqueryinfoa', 'httpqueryinfow', 'httpsendrequesta', 'httpsendrequestw', 'imagelist_add', 'imagelist_addmasked', 'imagelist_begindrag', 'imagelist_create', 'imagelist_destroy', 'imagelist_dragenter', 'imagelist_dragleave', 'imagelist_dragmove', 'imagelist_dragshownolock', 'imagelist_draw', 'imagelist_drawex', 'imagelist_enddrag', 'imagelist_getbkcolor', 'imagelist_getdragimage', 'imagelist_geticon', 'imagelist_geticonsize', 'imagelist_getimagecount', 'imagelist_getimageinfo', 'imagelist_loadimagew', 'imagelist_read', 'imagelist_remove', 'imagelist_replace', 'imagelist_replaceicon', 'imagelist_setbkcolor', 'imagelist_setdragcursorimage', 'imagelist_seticonsize', 'imagelist_setimagecount', 'imagelist_setoverlayimage', 'imagelist_write', 'immgetcontext', 'immreleasecontext', 'inet_addr', 'inet_ntoa', 'inflaterect', 'initcommoncontrols', 'initcommoncontrolsex', 'initialize', 'initializeacl', 'initializecriticalsection', 'initializecriticalsectionandspincount', 'initializesecuritydescriptor', 'initializesid', 'initializeslisthead', 'initiatesystemshutdownexw', 'insertmenua', 'insertmenuitema', 'insertmenuitemw', 'insertmenuw', 'interlockedcompareexchange', 'interlockeddecrement', 'interlockedexchange', 'interlockedexchangeadd', 'interlockedincrement', 'interlockedpopentryslist', 'interlockedpushentryslist', 'internetclosehandle', 'internetconnecta', 'internetconnectw', 'internetcrackurla', 'internetcrackurlw', 'interneterrordlg', 'internetopena', 'internetopenurlw', 'internetopenw', 'internetqueryoptionw', 'internetreadfile', 'internetsetoptionw', 'internetwritefile', 'intersectcliprect', 'intersectrect', 'invalidaterect', 'invalidatergn', 'invertrect', 'ioctlsocket', 'isaccelerator', 'isbadcodeptr', 'isbadreadptr', 'isbadwriteptr', 'ischild', 'isclipboardformatavailable', 'isdbcsleadbyte', 'isdbcsleadbyteex', 'isdebuggerpresent', 'isdialogmessagea', 'isdialogmessagew', 'isdlgbuttonchecked', 'isequalguid', 'isiconic', 'ismenu', 'isprocessorfeaturepresent', 'isrectempty', 'isvalidcodepage', 'isvalidlocale', 'isvalidsid', 'iswindow', 'iswindowenabled', 'iswindowunicode', 'iswindowvisible', 'iszoomed', 'killtimer', 'lcmapstringa', 'lcmapstringw', 'leavecriticalsection', 'linedda', 'lineto', 'listen', 'loadacceleratorsa', 'loadacceleratorsw', 'loadbitmapa', 'loadbitmapw', 'loadcursora', 'loadcursorw', 'loadicona', 'loadiconw', 'loadimagea', 'loadimagew', 'loadkeyboardlayouta', 'loadkeyboardlayoutw', 'loadlibrarya', 'loadlibraryexa', 'loadlibraryexw', 'loadlibraryw', 'loadmenuw', 'loadregtypelib', 'loadresource', 'loadstringa', 'loadstringw', 'loadtypelib', 'localalloc', 'localfiletimetofiletime', 'localfree', 'localrealloc', 'localtime', 'lockfile', 'lockfileex', 'lockresource', 'lockwindowupdate', 'lookupaccountnamew', 'lookupaccountsidw', 'lookupprivilegevaluea', 'lookupprivilegevaluew', 'lptodp', 'lresultfromobject', 'lstrcata', 'lstrcatw', 'lstrcmpa', 'lstrcmpia', 'lstrcmpiw', 'lstrcmpw', 'lstrcpya', 'lstrcpyna', 'lstrcpynw', 'lstrcpyw', 'lstrlena', 'lstrlenw', 'malloc', 'mapdialogrect', 'mapviewoffile', 'mapvirtualkeya', 'mapvirtualkeyw', 'mapwindowpoints', 'maskblt', 'memcmp', 'memcpy', 'memmove', 'memset', 'messagebeep', 'messageboxa', 'messageboxindirecta', 'messageboxindirectw', 'messageboxw', 'modifymenua', 'modifymenuw', 'monitorfrompoint', 'monitorfromwindow', 'movefilea', 'movefileexa', 'movefileexw', 'movefilew', 'movetoex', 'movewindow', 'msgwaitformultipleobjects', 'msgwaitformultipleobjectsex', 'muldiv', 'multibytetowidechar', 'ntclose', 'ntohl', 'ntohs', 'ntqueryinformationprocess', 'oemtochara', 'oemtocharbuffa', 'offsetrect', 'offsetrgn', 'offsetviewportorgex', 'olecreatefontindirect', 'oleduplicatedata', 'oleflushclipboard', 'olegetclipboard', 'oleinitialize', 'oleiscurrentclipboard', 'oleloadpicture', 'olelockrunning', 'olerun', 'oleuibusyw', 'oleuninitialize', 'openclipboard', 'openeventa', 'openeventw', 'openfilemappinga', 'openicon', 'openmutexa', 'openmutexw', 'openprocess', 'openprocesstoken', 'openscmanagerw', 'openservicew', 'openthreadtoken', 'outputdebugstringa', 'outputdebugstringw', 'patblt', 'path', 'pathappendw', 'pathcanonicalizew', 'pathfileexistsw', 'pathfindextensionw', 'pathfindfilenamew', 'pathisdirectoryw', 'pathisuncw', 'pathquotespacesw', 'pathremoveextensionw', 'pathremovefilespecw', 'pathstriptorootw', 'peekmessagea', 'peekmessagew', 'peeknamedpipe', 'pie', 'playenhmetafile', 'polybezierto', 'polygon', 'polyline', 'postmessagea', 'postmessagew', 'postquitmessage', 'postthreadmessagea', 'postthreadmessagew', 'printdlga', 'printf', 'process32firstw', 'process32nextw', 'processidtosessionid', 'progidfromclsid', 'program', 'propertysheetw', 'ptinrect', 'ptinregion', 'ptvisible', 'qae', 'qaeaav01', 'qaeaav12', 'qaeexz', 'qaexxz', 'qbe', 'querydosdevicew', 'queryperformancecounter', 'queryperformancefrequency', 'queryserviceconfigw', 'queryservicestatus', 'raiseexception', 'rand', 'readconsolew', 'readfile', 'readprocessmemory', 'realizepalette', 'realloc', 'rectangle', 'rectvisible', 'recv', 'recvfrom', 'redrawwindow', 'regclosekey', 'regconnectregistryw', 'regcreatekeya', 'regcreatekeyexa', 'regcreatekeyexw', 'regcreatekeyw', 'regdeletekeya', 'regdeletekeyw', 'regdeletevaluea', 'regdeletevaluew', 'regenumkeya', 'regenumkeyexa', 'regenumkeyexw', 'regenumkeyw', 'regenumvaluea', 'regenumvaluew', 'regflushkey', 'registerclassa', 'registerclassexa', 'registerclassexw', 'registerclassw', 'registerclipboardformata', 'registerclipboardformatw', 'registerdragdrop', 'registereventsourcew', 'registertraceguidsw', 'registertypelib', 'registerwindowmessagea', 'registerwindowmessagew', 'regopenkeya', 'regopenkeyexa', 'regopenkeyexw', 'regopenkeyw', 'regqueryinfokeya', 'regqueryinfokeyw', 'regqueryvaluea', 'regqueryvalueexa', 'regqueryvalueexw', 'regqueryvaluew', 'regsetvalueexa', 'regsetvalueexw', 'regsetvaluew', 'releasecapture', 'releasedc', 'releasemutex', 'releasesemaphore', 'releasestgmedium', 'removedirectorya', 'removedirectoryw', 'removefontresourcea', 'removemenu', 'removepropa', 'removepropw', 'replymessage', 'reporteventa', 'reporteventw', 'resetevent', 'restoredc', 'resumethread', 'reuseddelparam', 'reverttoself', 'revokedragdrop', 'roundrect', 'rpcstringfreew', 'rtlntstatustodoserror', 'rtlunwind', 'safearrayaccessdata', 'safearraycreate', 'safearraydestroy', 'safearraygetelement', 'safearraygetlbound', 'safearraygetubound', 'safearraygetvartype', 'safearrayptrofindex', 'safearrayputelement', 'safearrayunaccessdata', 'savedc', 'scaleviewportextex', 'scalewindowextex', 'screentoclient', 'scrollwindow', 'scrollwindowex', 'searchpatha', 'searchpathw', 'select', 'selectcliprgn', 'selectobject', 'selectpalette', 'send', 'senddlgitemmessagea', 'senddlgitemmessagew', 'sendmessagea', 'sendmessagetimeouta', 'sendmessagetimeoutw', 'sendmessagew', 'sendto', 'setabortproc', 'setactivewindow', 'setbkcolor', 'setbkmode', 'setbrushorgex', 'setcapture', 'setcaretpos', 'setclasslonga', 'setclasslongw', 'setclipboarddata', 'setconsolectrlhandler', 'setconsolemode', 'setcurrentdirectorya', 'setcurrentdirectoryw', 'setcursor', 'setcursorpos', 'setdibcolortable', 'setdibits', 'setdlgitemtexta', 'setdlgitemtextw', 'setendoffile', 'setenhmetafilebits', 'setentriesinacla', 'setentriesinaclw', 'setenvironmentvariablea', 'setenvironmentvariablew', 'seterrorinfo', 'seterrormode', 'setevent', 'setfileattributesa', 'setfileattributesw', 'setfilepointer', 'setfilepointerex', 'setfilesecuritya', 'setfilesecurityw', 'setfiletime', 'setfocus', 'setforegroundwindow', 'sethandlecount', 'sethandleinformation', 'setlasterror', 'setlayout', 'setlocale', 'setmapmode', 'setmenu', 'setmenudefaultitem', 'setmenuitembitmaps', 'setmenuiteminfoa', 'setmenuiteminfow', 'setnamedpipehandlestate', 'setnamedsecurityinfow', 'setpaletteentries', 'setparent', 'setpixel', 'setpolyfillmode', 'setpropa', 'setpropw', 'setrect', 'setrectempty', 'setrectrgn', 'setrop2', 'setscrollinfo', 'setscrollpos', 'setscrollrange', 'setsecuritydescriptordacl', 'setsecuritydescriptorgroup', 'setsecuritydescriptorowner', 'setservicestatus', 'setsockopt', 'setstdhandle', 'setstretchbltmode', 'settextalign', 'settextcolor', 'setthreadaffinitymask', 'setthreadcontext', 'setthreadexecutionstate', 'setthreadlocale', 'setthreadpriority', 'settimer', 'setunhandledexceptionfilter', 'setupdidestroydeviceinfolist', 'setupdienumdeviceinterfaces', 'setupdigetclassdevsw', 'setupdigetdeviceinterfacedetailw', 'setviewportextex', 'setviewportorgex', 'setwaitabletimer', 'setwindowcontexthelpid', 'setwindowextex', 'setwindowlonga', 'setwindowlongw', 'setwindoworgex', 'setwindowplacement', 'setwindowpos', 'setwindowrgn', 'setwindowshookexa', 'setwindowshookexw', 'setwindowtexta', 'setwindowtextw', 'setwinmetafilebits', 'shbrowseforfoldera', 'shbrowseforfolderw', 'shchangenotify', 'shdeletekeyw', 'shell_notifyicona', 'shell_notifyiconw', 'shellexecutea', 'shellexecuteexa', 'shellexecuteexw', 'shellexecutew', 'shfileoperationa', 'shfileoperationw', 'shgetdatafromidlistw', 'shgetdesktopfolder', 'shgetfileinfoa', 'shgetfileinfow', 'shgetfolderpatha', 'shgetfolderpathw', 'shgetmalloc', 'shgetpathfromidlista', 'shgetpathfromidlistw', 'shgetspecialfolderlocation', 'shgetspecialfolderpatha', 'shgetspecialfolderpathw', 'showcaret', 'showcursor', 'showownedpopups', 'showscrollbar', 'showwindow', 'shutdown', 'signal', 'signalobjectandwait', 'sizeofresource', 'sleep', 'sleepex', 'socket', 'sprintf', 'sscanf', 'startdoca', 'startpage', 'startservicectrldispatcherw', 'startservicew', 'std', 'stgcreatedocfileonilockbytes', 'stgopenstorageonilockbytes', 'strcat', 'strchr', 'strcmp', 'strcpy', 'stretchblt', 'stretchdibits', 'stringfromclsid', 'stringfromguid2', 'strlen', 'strncmp', 'strncpy', 'strrchr', 'strrettostrw', 'strstr', 'strtok', 'subtractrect', 'suspendthread', 'switchtothread', 'swprintf', 'sysallocstring', 'sysallocstringbytelen', 'sysallocstringlen', 'sysfreestring', 'sysreallocstringlen', 'sysstringbytelen', 'sysstringlen', 'systemfunction036', 'systemparametersinfoa', 'systemparametersinfow', 'systemtimetofiletime', 'systemtimetotzspecificlocaltime', 'systemtimetovarianttime', 'tabbedtextouta', 'tabbedtextoutw', 'tan', 'terminate', 'terminateprocess', 'terminatethread', 'textouta', 'textoutw', 'time', 'timebeginperiod', 'timeendperiod', 'timegettime', 'tlsalloc', 'tlsfree', 'tlsgetvalue', 'tlssetvalue', 'tolower', 'toupper', 'tracemessage', 'trackmouseevent', 'trackpopupmenu', 'trackpopupmenuex', 'transactnamedpipe', 'translateacceleratora', 'translateacceleratorw', 'translatecharsetinfo', 'translatemdisysaccel', 'translatemessage', 'transparentblt', 'tryentercriticalsection', 'uae', 'uaexxz', 'unhandledexceptionfilter', 'unhookwindowshookex', 'unionrect', 'unlockfile', 'unmapviewoffile', 'unpackddelparam', 'unrealizeobject', 'unregisterclassa', 'unregisterclassw', 'unregistertraceguids', 'updatelayeredwindow', 'updatewindow', 'uuidcreate', 'uuidtostringw', 'validaterect', 'varbstrfromdate', 'vardatefromstr', 'variantchangetype', 'variantchangetypeex', 'variantclear', 'variantcopy', 'variantcopyind', 'variantinit', 'varianttimetosystemtime', 'varui4fromstr', 'verifyversioninfow', 'verqueryvaluea', 'verqueryvaluew', 'versetconditionmask', 'virtualalloc', 'virtualallocex', 'virtualfree', 'virtualprotect', 'virtualprotectex', 'virtualquery', 'virtualqueryex', 'waitforinputidle', 'waitformultipleobjects', 'waitformultipleobjectsex', 'waitforsingleobject', 'waitforsingleobjectex', 'waitmessage', 'wcscat', 'wcschr', 'wcscmp', 'wcscpy', 'wcslen', 'wcsncmp', 'wcsncpy', 'wcsrchr', 'wcsstr', 'wcstok', 'wcstol', 'wcstoul', 'widechartomultibyte', 'windowfrompoint', 'winexec', 'winhelpa', 'winhelpw', 'winhttpopen', 'winverifytrust', 'wnetcloseenum', 'writeconsolea', 'writeconsolew', 'writefile', 'writeprivateprofilestringa', 'writeprivateprofilestringw', 'writeprocessmemory', 'wsacleanup', 'wsagetlasterror', 'wsasetlasterror', 'wsastartup', 'wsprintfa', 'wsprintfw', 'wstring', 'wthelpergetprovsignerfromchain', 'wthelperprovdatafromstatedata', 'wvsprintfa', 'wvsprintfw', 'xz', 'yapaxi', 'yaxpax', 'yaxxz']

X = [] # features from Structure_Info.txt
Y = [] # whether malware or benign
P = []
Q = [] # Selected API features
R = [] # whether malware or benign
filename = []
apis = 1500

def featureExtraction():
    for folder in os.listdir():
        filename.append(folder)
        with open(folder+'/Structure_Info.txt','r',encoding='latin1') as file:
            f = [0]*37
            data = file.readlines() 
            for line in data:
                word = line.split()
                for tag in word:
                    if tag in features:
                        if(tag=='DllCharacteristics:' and word.index(tag)==0):
                            break
                        if(word[word.index(tag)+1][0]!='0' and word[word.index(tag)+1][1]!='x'):
                            break
                        ind = word.index(tag)+1
                        if(ind<len(word)):
                            f[features[tag]] = int(word[word.index(tag)+1],16) 
            X.append(f)

def apiSelection(type_of_files):
    os.chdir("E:\MalwareMidsem\Static_Analysis_RAWDATA\\"+type_of_files)
    for folder in os.listdir():
        with open(folder+'\Structure_Info.txt','r',encoding='latin1') as file:
            apis_string = ''
            data = file.readlines() 
            for line in data:
                word = line.split()
                for api in word:
                    if '.dll.' in api.lower():
                        apis_string = apis_string + ' ' + api.split('.')[2]
            P.append(apis_string)

def apiExtraction():
    for folder in os.listdir():
        with open(folder+'/Structure_Info.txt','r',encoding='latin1') as file:
            f = [0]*apis
            data = file.readlines() 
            for line in data:
                word = line.split()
                for api in word:
                    if '.dll.' in api.lower():
                        d = api.split('.')[2]
                        if d in reduced_apis:
                            f[reduced_apis.index(d)] = 1
        Q.append(f)

def decisionTree(M,N):
    M_train, M_test, N_train, N_test = train_test_split(M, N, test_size = 0.25, random_state = 100)
    clf = DecisionTreeClassifier()
    clf.fit(M_train,N_train) 
    N_pred = clf.predict(M_test) 
    print ("Accuracy using Decision Tree: ", accuracy_score(N_test,N_pred)*100) 

def ensembler(M,N):
    clf1 = DecisionTreeClassifier()
    clf2 = DecisionTreeClassifier()
    eclf = EnsembleVoteClassifier(clfs=[clf1, clf2], voting='soft')
    eclf = eclf.fit(M,N)
    N_pred = eclf.predict(M) 
    print ("Accuracy using Ensemble of Decision Tree: ", accuracy_score(N,N_pred)*100) 
    pickle.dump(eclf,open("model", "wb" )) 

def saveFeatures():
    with open("static_analysis_features","wb") as file:
        pickle.dump([X,Y,Q,R],file)
        
def loadFeatures():
    with open("static_analysis_features","rb") as file:
        data = pickle.load(file)
        X = data[0]
        Y = data[1]
        Q = data[2]
        R = data[3]
        return X,Y,Q,R
    
def applyModel():
    M = np.column_stack((X,Q))
    eclf = pickle.load(open("model","rb"))
    N = eclf.predict(M)
    with open('static.csv',mode='w',newline='') as file:
        f = csv.writer(file)
        f.writerow(['File_Hash','Predicted Label'])
        for i in range(0,len(N)): 
            if(N[i]==1):
                label = 'M'
            else:
                label = 'B'
            f.writerow([filename[i],label])
    print("PREDICTION COMPLETE.")
        
if __name__ == "__main__":
    #TRAINING
    #1) Initial settings
    # owd=os.getcwd()

    #2) Extracting features from Structure_Info.txt
    # featureExtraction("Benign",0)
    # featureExtraction("Malware",1)

    #3) Selecting useful APIs using TFIDF
    # apiSelection("Benign")
    # apiSelection("Malware")
    # vectorizer = TfidfVectorizer(max_features=apis)
    # vectors = vectorizer.fit_transform(P)
    # feature_names = vectorizer.get_feature_names()
    # print(feature_names)

    #4) Extracting selected APIs
    # apiExtraction("Benign",0)
    # apiExtraction("Malware",1)
    # os.chdir(owd)
    # saveFeatures()

    #5) Preparing Model (Ensemble of Decision Trees)
    # X,Y,Q,R = loadFeatures()
    # M = np.column_stack((X,Q))
    # ensembler(M,Y)

    #6) Applying K-fold
    # M = np.array(M)
    # N = np.array(N)
    # kf = KFold(n_splits=5)
    # kf.get_n_splits(M)
    # KFold(n_splits=5, random_state=None, shuffle=False)
    # for train_index, test_index in kf.split(M):
    #     M_train, M_test = M[train_index], M[test_index]
    #     N_train, N_test = N[train_index], N[test_index]
    #Applying Test and Split
    # M_train, M_test, N_train, N_test = train_test_split(M, N, test_size = 0.25, random_state = 100)

    #TESTING
    #7) Applying Model
    owd=os.getcwd()
    os.chdir(sys.argv[1])
    featureExtraction()
    apiExtraction()
    os.chdir(owd)
    applyModel()





