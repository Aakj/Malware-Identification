#!/usr/bin/env python
# coding: utf-8

import os
import sys
import json
import csv
import pickle
import numpy as np
#import pandas as pd
#from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score 
#from sklearn.model_selection import KFold
#from feature_selector import FeatureSelector

# Properties in behavior:
#'file_recreated', 'file_opened', 'guid', 'regkey_opened', 'command_line', 'dll_loaded', 'file_created', 'connects_host', 
# 'tls_master', 'regkey_read', 'regkey_deleted', 'file_exists', 'connects_ip', 'fetches_url', 'file_copied', 'file_written', 
# 'directory_removed', 'directory_enumerated', 'wmi_query', 'file_failed', 'mutex', 'directory_created', 'resolves_host', 
# 'file_moved', 'regkey_written', 'file_read', 'file_deleted'

# Intiial features:
info_i = {'duration':0,'score':1}
network_i = {'udp':3,'irc':4,'http':5,'smtp':6,'tcp':7,'hosts':8,'dns_servers':9,
           'domains':10,'icmp':11}
processes_i = {'process_count':12}
behavior_summary_i = {'dll_loaded':13,'file_opened':14,'file_read':15,'file_created':16,'file_written':17,'file_deleted':18,
             'regkey_opened':19,'regkey_read':20, 'regkey_deleted':21,'command_line':22,'wmi_query':23,'mutex':24,
             'directory_created':25, 'resolves_host':26}
api_category_i = {'certificate':27, 'synchronisation':28, 'services':29, 'process':30, 'ole':31, 'netapi':32, 'resource':33,
                 'ui':34, 'system':35, 'exception':36, 'network':37, 'crypto':38, '__notification__':39, 'file':40, 'misc':41,
                 'registry':42}
all_features_i = ['duration','score','udp','irc','http','smtp','tcp','hosts','dns_servers','domains','icmp','process_count','dll_loaded',
        'file_opened','file_read','file_created','file_written','file_deleted','regkey_opened','regkey_read', 'regkey_deleted',
        'command_line','wmi_query','mutex','directory_created', 'resolves_host','certificate', 'synchronisation', 'services',
        'process', 'ole', 'netapi', 'resource','ui', 'system', 'exception', 'network', 'crypto', '__notification__', 'file', 
        'misc','registry','GetTimeZoneInformation', 'CryptCreateHash', 'Process32NextW', 'SetFilePointerEx', 'GetFileVersionInfoExW', 'GetVolumePathNameW', 'NtAllocateVirtualMemory', 'GetShortPathNameW', 'WSARecv', 'NtQuerySystemInformation', '__exception__', 'GetKeyState', 'GetUserNameExW', 'InternetOpenA', 'HttpOpenRequestA', 'OpenServiceW', 'NtFreeVirtualMemory', 'UnhookWindowsHookEx', 'GlobalMemoryStatus', 'NtQueueApcThread', 'GetFileType', 'NtQueryDirectoryFile', 'NtSuspendThread', 'bind', 'GetUserNameA', 'LoadStringA', 'NtQueryAttributesFile', 'GetFileAttributesExW', 'OpenServiceA', 'GetFileVersionInfoW', 'FindResourceW', 'GetVolumePathNamesForVolumeNameW', 'GetKeyboardState', 'SendNotifyMessageW', 'connect', 'CopyFileA', 'SetFileTime', 'RegDeleteValueA', 'CoInitializeEx', 'NtCreateMutant', 'SHGetSpecialFolderLocation', 'RegEnumKeyExA', 'NetShareEnum', 'RemoveDirectoryA', 'Module32NextW', 'NtUnmapViewOfSection', 'GetAdaptersInfo', 'WriteConsoleW', 'GetFileInformationByHandleEx', 'CertOpenSystemStoreA', 'FindFirstFileExW', 'CreateJobObjectW', 'GetFileVersionInfoSizeExW', 'SetEndOfFile', 'RegOpenKeyExW', 'NtQueryMultipleValueKey', 'InternetOpenUrlA', 'WSASocketW', 'RegQueryInfoKeyW', 'FindWindowA', 'FindResourceA', 'NtReadFile', 'OleInitialize', 'NtSetInformationFile', 'NtProtectVirtualMemory', 'RegDeleteValueW', 'WSARecvFrom', 'CoCreateInstanceEx', 'SHGetFolderPathW', 'InternetCloseHandle', 'FindFirstFileExA', 'GetSystemDirectoryW', 'GetDiskFreeSpaceW', 'SetStdHandle', 'InternetOpenW', 'InternetGetConnectedState', 'CryptUnprotectMemory', 'HttpOpenRequestW', 'GetSystemWindowsDirectoryA', 'GetSystemWindowsDirectoryW', 'EnumServicesStatusW', 'PRF', 'system', 'StartServiceA', 'RtlCreateUserThread', 'NtOpenThread', 'IWbemServices_ExecQuery', 'WNetGetProviderNameW', 'SizeofResource', 'SetFileInformationByHandle', 'FindWindowExW', 'SendNotifyMessageA', 'DnsQuery_W', 'Module32FirstW', 'GetNativeSystemInfo', 'RtlAddVectoredExceptionHandler', 'SetFilePointer', 'getsockname', 'CryptAcquireContextW', 'WSASendTo', 'shutdown', 'CertControlStore', 'CryptProtectData', 'NtOpenFile', 'LdrGetProcedureAddress', 'CreateThread', 'NtQueryFullAttributesFile', 'RtlAddVectoredContinueHandler', 'CryptDecrypt', 'NtDeviceIoControlFile', 'RegOpenKeyExA', 'CryptGenKey', 'GetSystemMetrics', 'gethostbyname', 'NtResumeThread', 'MoveFileWithProgressW', 'RegEnumKeyW', 'NtDuplicateObject', 'LookupAccountSidW', 'GetDiskFreeSpaceExW', 'GetAsyncKeyState', 'LookupPrivilegeValueW', 'GetAdaptersAddresses', 'NtQueryInformationFile', 'SetWindowsHookExA', 'CreateRemoteThreadEx', 'FindResourceExW', 'CreateToolhelp32Snapshot', 'NtEnumerateValueKey', 'DeviceIoControl', 'NtCreateKey', 'EnumWindows', 'InternetSetOptionA', 'ControlService', 'WriteConsoleA', 'RegQueryValueExA', 'CopyFileW', 'listen', 'OpenSCManagerA', 'CryptHashData', 'GetFileSize', 'DrawTextExW', 'NtCreateSection', 'NtWriteVirtualMemory', 'setsockopt', 'FindWindowExA', 'SearchPathW', 'GetFileInformationByHandle', 'NtMapViewOfSection', 'CryptExportKey', 'NtOpenKey', 'RegQueryInfoKeyA', 'GetUserNameW', 'NtDeleteKey', 'ExitWindowsEx', 'GetComputerNameW', 'ReadProcessMemory', 'NtOpenProcess', 'OutputDebugStringA', 'CoInitializeSecurity', 'FindResourceExA', 'LdrLoadDll', 'NtOpenKeyEx', 'GetSystemDirectoryA', 'GetUserNameExA', 'CoCreateInstance', 'InternetGetConnectedStateExA', 'NtWriteFile', 'InternetCrackUrlA', 'GetBestInterfaceEx', 'WriteProcessMemory', 'NtQueryValueKey', 'EnumServicesStatusA', 'NtSetValueKey', 'CreateDirectoryExW', 'WSAStartup', 'CreateRemoteThread', 'NetGetJoinInformation', 'NtOpenDirectoryObject', 'GetFileVersionInfoSizeW', 'GetFileSizeEx', 'GlobalMemoryStatusEx', 'MessageBoxTimeoutA', 'HttpSendRequestW', 'sendto', 'NtCreateFile', 'OpenSCManagerW', 'InternetConnectW', 'RegEnumValueA', 'ioctlsocket', 'NtCreateThreadEx', 'ObtainUserAgentString', 'RtlDecompressBuffer', 'ShellExecuteExW', 'CreateActCtxW', 'GetSystemTimeAsFileTime', 'SetFileAttributesW', 'send', 'NtLoadDriver', 'NtSetContextThread', 'GetAddrInfoW', 'RegCreateKeyExW', 'RegCreateKeyExA', 'CertCreateCertificateContext', 'InternetConnectA', 'CertOpenStore', 'NtReadVirtualMemory', 'HttpQueryInfoA', 'LdrGetDllHandle', 'Thread32First', 'RtlRemoveVectoredExceptionHandler', 'StartServiceW', 'NtTerminateThread', 'CreateProcessInternalW', 'DeleteFileW', 'CoUninitialize', 'CreateServiceA', 'CreateServiceW', 'InternetQueryOptionA', 'GetSystemInfo', 'CoGetClassObject', 'InternetSetStatusCallback', 'TaskDialog', 'Process32FirstW', 'NtOpenSection', 'NtTerminateProcess', 'DeleteUrlCacheEntryW', 'SetInformationJobObject', 'CopyFileExW', 'HttpSendRequestA', 'RegQueryValueExW', 'DrawTextExA', 'NtEnumerateKey', 'CryptAcquireContextA', 'getaddrinfo', 'accept', 'CreateDirectoryW', 'NtClose', 'NtDelayExecution', 'AssignProcessToJobObject', 'select', 'CryptDecodeObjectEx', 'NtGetContextThread', 'RegSetValueExA', 'recvfrom', 'SetErrorMode', 'SetWindowsHookExW', 'LdrUnloadDll', 'GetVolumeNameForVolumeMountPointW', 'RegEnumKeyExW', 'socket', 'recv', 'NtDeleteValueKey', 'ReadCabinetState', 'Thread32Next', 'GetInterfaceInfo', 'IsDebuggerPresent', 'NtQueryKey', 'closesocket', 'IWbemServices_ExecMethod', 'GetTempPathW', 'FindWindowW', 'UuidCreate', 'InternetCrackUrlW', 'CryptProtectMemory', 'InternetOpenUrlW', 'NetUserGetInfo', 'LoadStringW', 'GetCursorPos', 'LoadResource', 'MessageBoxTimeoutW', 'GetComputerNameA', 'GetFileAttributesW', 'RegSetValueExW', 'RegisterHotKey', 'RemoveDirectoryW', 'SetUnhandledExceptionFilter', 'GetForegroundWindow', 'RegCloseKey', 'NtOpenMutant', 'timeGetTime', 'RegEnumValueW', 'DeleteService', 'WSASocketA', 'RegDeleteKeyW', 'RegDeleteKeyA','TARGET']
unique_apis_i = ['GetTimeZoneInformation', 'CryptCreateHash', 'Process32NextW', 'SetFilePointerEx', 'GetFileVersionInfoExW', 'GetVolumePathNameW', 'NtAllocateVirtualMemory', 'GetShortPathNameW', 'WSARecv', 'NtQuerySystemInformation', '__exception__', 'GetKeyState', 'GetUserNameExW', 'InternetOpenA', 'HttpOpenRequestA', 'OpenServiceW', 'NtFreeVirtualMemory', 'UnhookWindowsHookEx', 'GlobalMemoryStatus', 'NtQueueApcThread', 'GetFileType', 'NtQueryDirectoryFile', 'NtSuspendThread', 'bind', 'GetUserNameA', 'LoadStringA', 'NtQueryAttributesFile', 'GetFileAttributesExW', 'OpenServiceA', 'GetFileVersionInfoW', 'FindResourceW', 'GetVolumePathNamesForVolumeNameW', 'GetKeyboardState', 'SendNotifyMessageW', 'connect', 'CopyFileA', 'SetFileTime', 'RegDeleteValueA', 'CoInitializeEx', 'NtCreateMutant', 'SHGetSpecialFolderLocation', 'RegEnumKeyExA', 'NetShareEnum', 'RemoveDirectoryA', 'Module32NextW', 'NtUnmapViewOfSection', 'GetAdaptersInfo', 'WriteConsoleW', 'GetFileInformationByHandleEx', 'CertOpenSystemStoreA', 'FindFirstFileExW', 'CreateJobObjectW', 'GetFileVersionInfoSizeExW', 'SetEndOfFile', 'RegOpenKeyExW', 'NtQueryMultipleValueKey', 'InternetOpenUrlA', 'WSASocketW', 'RegQueryInfoKeyW', 'FindWindowA', 'FindResourceA', 'NtReadFile', 'OleInitialize', 'NtSetInformationFile', 'NtProtectVirtualMemory', 'RegDeleteValueW', 'WSARecvFrom', 'CoCreateInstanceEx', 'SHGetFolderPathW', 'InternetCloseHandle', 'FindFirstFileExA', 'GetSystemDirectoryW', 'GetDiskFreeSpaceW', 'SetStdHandle', 'InternetOpenW', 'InternetGetConnectedState', 'CryptUnprotectMemory', 'HttpOpenRequestW', 'GetSystemWindowsDirectoryA', 'GetSystemWindowsDirectoryW', 'EnumServicesStatusW', 'PRF', 'system', 'StartServiceA', 'RtlCreateUserThread', 'NtOpenThread', 'IWbemServices_ExecQuery', 'WNetGetProviderNameW', 'SizeofResource', 'SetFileInformationByHandle', 'FindWindowExW', 'SendNotifyMessageA', 'DnsQuery_W', 'Module32FirstW', 'GetNativeSystemInfo', 'RtlAddVectoredExceptionHandler', 'SetFilePointer', 'getsockname', 'CryptAcquireContextW', 'WSASendTo', 'shutdown', 'CertControlStore', 'CryptProtectData', 'NtOpenFile', 'LdrGetProcedureAddress', 'CreateThread', 'NtQueryFullAttributesFile', 'RtlAddVectoredContinueHandler', 'CryptDecrypt', 'NtDeviceIoControlFile', 'RegOpenKeyExA', 'CryptGenKey', 'GetSystemMetrics', 'gethostbyname', 'NtResumeThread', 'MoveFileWithProgressW', 'RegEnumKeyW', 'NtDuplicateObject', 'LookupAccountSidW', 'GetDiskFreeSpaceExW', 'GetAsyncKeyState', 'LookupPrivilegeValueW', 'GetAdaptersAddresses', 'NtQueryInformationFile', 'SetWindowsHookExA', 'CreateRemoteThreadEx', 'FindResourceExW', 'CreateToolhelp32Snapshot', 'NtEnumerateValueKey', 'DeviceIoControl', 'NtCreateKey', 'EnumWindows', 'InternetSetOptionA', 'ControlService', 'WriteConsoleA', 'RegQueryValueExA', 'CopyFileW', 'listen', 'OpenSCManagerA', 'CryptHashData', 'GetFileSize', 'DrawTextExW', 'NtCreateSection', 'NtWriteVirtualMemory', 'setsockopt', 'FindWindowExA', 'SearchPathW', 'GetFileInformationByHandle', 'NtMapViewOfSection', 'CryptExportKey', 'NtOpenKey', 'RegQueryInfoKeyA', 'GetUserNameW', 'NtDeleteKey', 'ExitWindowsEx', 'GetComputerNameW', 'ReadProcessMemory', 'NtOpenProcess', 'OutputDebugStringA', 'CoInitializeSecurity', 'FindResourceExA', 'LdrLoadDll', 'NtOpenKeyEx', 'GetSystemDirectoryA', 'GetUserNameExA', 'CoCreateInstance', 'InternetGetConnectedStateExA', 'NtWriteFile', 'InternetCrackUrlA', 'GetBestInterfaceEx', 'WriteProcessMemory', 'NtQueryValueKey', 'EnumServicesStatusA', 'NtSetValueKey', 'CreateDirectoryExW', 'WSAStartup', 'CreateRemoteThread', 'NetGetJoinInformation', 'NtOpenDirectoryObject', 'GetFileVersionInfoSizeW', 'GetFileSizeEx', 'GlobalMemoryStatusEx', 'MessageBoxTimeoutA', 'HttpSendRequestW', 'sendto', 'NtCreateFile', 'OpenSCManagerW', 'InternetConnectW', 'RegEnumValueA', 'ioctlsocket', 'NtCreateThreadEx', 'ObtainUserAgentString', 'RtlDecompressBuffer', 'ShellExecuteExW', 'CreateActCtxW', 'GetSystemTimeAsFileTime', 'SetFileAttributesW', 'send', 'NtLoadDriver', 'NtSetContextThread', 'GetAddrInfoW', 'RegCreateKeyExW', 'RegCreateKeyExA', 'CertCreateCertificateContext', 'InternetConnectA', 'CertOpenStore', 'NtReadVirtualMemory', 'HttpQueryInfoA', 'LdrGetDllHandle', 'Thread32First', 'RtlRemoveVectoredExceptionHandler', 'StartServiceW', 'NtTerminateThread', 'CreateProcessInternalW', 'DeleteFileW', 'CoUninitialize', 'CreateServiceA', 'CreateServiceW', 'InternetQueryOptionA', 'GetSystemInfo', 'CoGetClassObject', 'InternetSetStatusCallback', 'TaskDialog', 'Process32FirstW', 'NtOpenSection', 'NtTerminateProcess', 'DeleteUrlCacheEntryW', 'SetInformationJobObject', 'CopyFileExW', 'HttpSendRequestA', 'RegQueryValueExW', 'DrawTextExA', 'NtEnumerateKey', 'CryptAcquireContextA', 'getaddrinfo', 'accept', 'CreateDirectoryW', 'NtClose', 'NtDelayExecution', 'AssignProcessToJobObject', 'select', 'CryptDecodeObjectEx', 'NtGetContextThread', 'RegSetValueExA', 'recvfrom', 'SetErrorMode', 'SetWindowsHookExW', 'LdrUnloadDll', 'GetVolumeNameForVolumeMountPointW', 'RegEnumKeyExW', 'socket', 'recv', 'NtDeleteValueKey', 'ReadCabinetState', 'Thread32Next', 'GetInterfaceInfo', 'IsDebuggerPresent', 'NtQueryKey', 'closesocket', 'IWbemServices_ExecMethod', 'GetTempPathW', 'FindWindowW', 'UuidCreate', 'InternetCrackUrlW', 'CryptProtectMemory', 'InternetOpenUrlW', 'NetUserGetInfo', 'LoadStringW', 'GetCursorPos', 'LoadResource', 'MessageBoxTimeoutW', 'GetComputerNameA', 'GetFileAttributesW', 'RegSetValueExW', 'RegisterHotKey', 'RemoveDirectoryW', 'SetUnhandledExceptionFilter', 'GetForegroundWindow', 'RegCloseKey', 'NtOpenMutant', 'timeGetTime', 'RegEnumValueW', 'DeleteService', 'WSASocketA', 'RegDeleteKeyW', 'RegDeleteKeyA']

#Updated features:
info = {'duration':0,'score':1}
network = {'udp':2,'http':3,'tcp':4,'dns_servers':5,'domains':6}
behavior_summary = {'dll_loaded':7,'file_opened':8,'file_read':9,'file_created':10,'file_written':11,'file_deleted':12,
             'regkey_opened':13,'regkey_read':14,'mutex':15,'directory_created':16}
api_category = {'certificate':17, 'synchronisation':18, 'services':19, 'process':20, 'ole':21, 'resource':22,'ui':23, 
                'system':24, 'network':25, 'file':26, 'misc':27, 'registry':28}
unique_apis = ['NtAllocateVirtualMemory', 'GetKeyState', 'NtFreeVirtualMemory', 'GetFileType', 'RegOpenKeyExW', 'NtReadFile', 'NtProtectVirtualMemory', 'system', 'SizeofResource', 'SetFilePointer', 'LdrGetProcedureAddress', 'GetSystemMetrics', 'SearchPathW', 'LdrLoadDll', 'NtCreateFile', 'RegQueryValueExW', 'NtClose', 'system.1']

waste_apis = ['GetAddrInfoW', 'HttpSendRequestW', 'LdrGetDllHandle', 'sendto', 'HttpQueryInfoA', 'OpenSCManagerW', 'NtReadVirtualMemory', 'InternetConnectW', 'CertOpenStore', 'RegEnumValueA', 'ioctlsocket', 'InternetConnectA', 'CertCreateCertificateContext', 'NtCreateThreadEx', 'NtSetContextThread', 'ObtainUserAgentString', 'RtlDecompressBuffer', 'ShellExecuteExW', 'CreateActCtxW', 'GetSystemTimeAsFileTime', 'RegCreateKeyExA', 'RegCreateKeyExW', 'GlobalMemoryStatusEx', 'SetFileAttributesW', 'send', 'NtLoadDriver', 'MessageBoxTimeoutA', 'InternetGetConnectedStateExA', 'GetFileSizeEx', 'GetFileVersionInfoSizeW', 'CoInitializeSecurity', 'OutputDebugStringA', 'NtOpenProcess', 'ReadProcessMemory', 'GetComputerNameW', 'ExitWindowsEx', 'NtDeleteKey', 'GetUserNameW', 'RegQueryInfoKeyA', 'NtOpenKey', 'CryptExportKey', 'NtMapViewOfSection', 'GetFileInformationByHandle', 'FindWindowExA', 'setsockopt', 'FindResourceExA', 'NtOpenKeyEx', 'GetSystemDirectoryA', 'EnumServicesStatusA', 'NtOpenDirectoryObject', 'NetGetJoinInformation', 'CreateRemoteThread', 'WSAStartup', 'CreateDirectoryExW', 'NtSetValueKey', 'NtQueryValueKey', 'GetUserNameExA', 'WriteProcessMemory', 'GetBestInterfaceEx', 'InternetCrackUrlA', 'NtWriteFile', 'RtlRemoveVectoredExceptionHandler', 'CoCreateInstance', 'Thread32First', 'DeleteUrlCacheEntryW', 'StartServiceW', 'socket', 'NetUserGetInfo', 'InternetOpenUrlW', 'CryptProtectMemory', 'InternetCrackUrlW', 'UuidCreate', 'FindWindowW', 'GetTempPathW', 'IWbemServices_ExecMethod', 'closesocket', 'NtQueryKey', 'IsDebuggerPresent', 'GetInterfaceInfo', 'Thread32Next', 'ReadCabinetState', 'NtDeleteValueKey', 'LoadStringW', 'GetCursorPos', 'LoadResource', 'RegCloseKey', 'RegDeleteKeyW', 'WSASocketA', 'DeleteService', 'RegEnumValueW', 'timeGetTime', 'NtOpenMutant', 'GetForegroundWindow', 'MessageBoxTimeoutW', 'SetUnhandledExceptionFilter', 'RemoveDirectoryW', 'RegisterHotKey', 'RegSetValueExW', 'GetFileAttributesW', 'GetComputerNameA', 'recv', 'RegEnumKeyExW', 'NtTerminateThread', 'GetVolumeNameForVolumeMountPointW', 'SetInformationJobObject', 'NtCreateSection', 'NtTerminateProcess', 'NtOpenSection', 'Process32FirstW', 'TaskDialog', 'InternetSetStatusCallback', 'CoGetClassObject', 'GetSystemInfo', 'InternetQueryOptionA', 'CreateServiceW', 'CreateServiceA', 'CoUninitialize', 'DeleteFileW', 'CreateProcessInternalW', 'CopyFileExW', 'HttpSendRequestA', 'DrawTextExA', 'CryptDecodeObjectEx', 'LdrUnloadDll', 'SetWindowsHookExW', 'SetErrorMode', 'recvfrom', 'RegSetValueExA', 'NtGetContextThread', 'select', 'NtEnumerateKey', 'AssignProcessToJobObject', 'NtDelayExecution', 'CreateDirectoryW', 'accept', 'getaddrinfo', 'CryptAcquireContextA', 'NtWriteVirtualMemory', 'GetAdaptersAddresses', 'DrawTextExW', 'GetFileSize', 'RegEnumKeyExA', 'SHGetSpecialFolderLocation', 'NtCreateMutant', 'CoInitializeEx', 'RegDeleteValueA', 'SetFileTime', 'CopyFileA', 'connect', 'SendNotifyMessageW', 'GetKeyboardState', 'GetVolumePathNamesForVolumeNameW', 'FindResourceW', 'GetFileVersionInfoW', 'OpenServiceA', 'GetFileAttributesExW', 'NetShareEnum', 'RemoveDirectoryA', 'Module32NextW', 'SetEndOfFile', 'FindResourceA', 'FindWindowA', 'RegQueryInfoKeyW', 'WSASocketW', 'InternetOpenUrlA', 'NtQueryMultipleValueKey', 'GetFileVersionInfoSizeExW', 'NtUnmapViewOfSection', 'CreateJobObjectW', 'FindFirstFileExW', 'CertOpenSystemStoreA', 'GetFileInformationByHandleEx', 'WriteConsoleW', 'GetAdaptersInfo', 'NtQueryAttributesFile', 'LoadStringA', 'GetUserNameA', 'GetTimeZoneInformation', 'Process32NextW', 'CryptCreateHash', 'SetFilePointerEx', 'bind', 'HttpOpenRequestA', 'NtSuspendThread', 'NtQueryDirectoryFile', 'NtQueueApcThread', 'GlobalMemoryStatus', 'UnhookWindowsHookEx', 'OpenServiceW', 'InternetOpenA', 'GetFileVersionInfoExW', 'GetUserNameExW', '__exception__', 'NtQuerySystemInformation', 'WSARecv', 'GetShortPathNameW', 'GetVolumePathNameW', 'OleInitialize', 'NtSetInformationFile', 'RegDeleteValueW', 'NtResumeThread', 'GetAsyncKeyState', 'GetDiskFreeSpaceExW', 'LookupAccountSidW', 'NtDuplicateObject', 'RegEnumKeyW', 'MoveFileWithProgressW', 'gethostbyname', 'NtQueryInformationFile', 'CryptGenKey', 'RegOpenKeyExA', 'NtDeviceIoControlFile', 'CryptDecrypt', 'RtlAddVectoredContinueHandler', 'NtQueryFullAttributesFile', 'LookupPrivilegeValueW', 'SetWindowsHookExA', 'NtOpenFile', 'ControlService', 'CryptHashData', 'OpenSCManagerA', 'listen', 'CopyFileW', 'RegQueryValueExA', 'WriteConsoleA', 'InternetSetOptionA', 'CreateRemoteThreadEx', 'EnumWindows', 'NtCreateKey', 'DeviceIoControl', 'NtEnumerateValueKey', 'CreateToolhelp32Snapshot', 'FindResourceExW', 'CreateThread', 'CryptProtectData', 'WSARecvFrom', 'InternetOpenW', 'EnumServicesStatusW', 'GetSystemWindowsDirectoryW', 'GetSystemWindowsDirectoryA', 'HttpOpenRequestW', 'CryptUnprotectMemory', 'InternetGetConnectedState', 'SetStdHandle', 'system.1', 'GetDiskFreeSpaceW', 'GetSystemDirectoryW', 'FindFirstFileExA', 'InternetCloseHandle', 'SHGetFolderPathW', 'CoCreateInstanceEx', 'PRF', 'StartServiceA', 'CertControlStore', 'Module32FirstW', 'shutdown', 'WSASendTo', 'CryptAcquireContextW', 'getsockname', 'RtlAddVectoredExceptionHandler', 'GetNativeSystemInfo', 'DnsQuery_W', 'RtlCreateUserThread', 'SendNotifyMessageA', 'FindWindowExW', 'SetFileInformationByHandle', 'WNetGetProviderNameW', 'IWbemServices_ExecQuery', 'NtOpenThread', 'RegDeleteKeyA']

              
X = [] # features (info,virustotal,network,processes,behavious,apiCategories)
Y = [] # whether malware or benign
Q = [] # features (countOfAPIs)
R = [] # whethet malware or benign
M = []
filename = []

def featureExtraction(): #Count = 29
    #os.chdir("E:\MalwareMidsem\Dynamic_Analysis_RAWDATA\\"+type_of_file)
    for file in os.listdir():
        with open(file) as content:
            data = json.load(content)
            f = [0]*29
            if 'info' in data:
                if 'duration' in data['info']:
                    f[0] = data['info']['duration']
                if 'score' in data['info']:
                    f[1] = data['info']['score']
            if 'network' in data:
                net = data['network']
                for attribute in network:
                    if attribute in net:
                        f[network[attribute]] = len(net[attribute])
            if 'behavior' in data:
                behave = data['behavior']
                if 'summary' in behave:
                    for tag in behave['summary']:
                        if tag in behavior_summary:
                            f[behavior_summary[tag]] = len(behave['summary'][tag])
                if 'processes' in behave:
                    for p in behave['processes']:
                        if 'calls' in p:
                            for i in range(0,len(p['calls'])):
                                c = p['calls'][i]['category']
                                if c in api_category:
                                    f[api_category[c]] = f[api_category[c]] + 1
            X.append(f)
            #Y.append(flag)

def apiCategoryExtraction(type_of_file,flag):
    os.chdir("E:\MalwareMidsem\Dynamic_Analysis_RAWDATA\\"+type_of_file)
    for file in os.listdir():
        with open(file) as content:
            data = json.load(content)
            if 'behavior' in data:
                behave = data['behavior']
                if 'processes' in behave:
                    for p in behave['processes']:
                        if 'calls' in p:
                            for i in range(0,len(p['calls'])):
                                category.add(p['calls'][i]['category'])
                   
def apiExtraction(type_of_file):
    os.chdir("E:\MalwareMidsem\Dynamic_Analysis_RAWDATA\\"+type_of_file)
    for file in os.listdir():
        with open(file) as content:
            data = json.load(content)
            if 'behavior' in data:
                behave = data['behavior']
                if 'apistats' in behave:
                    for key,values in behave['apistats'].items():
                        for p in values:
                            apis.add(p)
                            
def apiCountExtraction():
    #os.chdir("E:\MalwareMidsem\Dynamic_Analysis_RAWDATA\\"+type_of_file)
    for file in os.listdir():
        filename.append(file)
        with open(file) as content:
            data = json.load(content)
            f = [0]*len(unique_apis)
            if 'behavior' in data:
                behave = data['behavior']
                if 'apistats' in behave:
                    for key,values in behave['apistats'].items():
                        for t in values:
                            if t in unique_apis:
                                f[unique_apis.index(t)] = behave['apistats'][key][t]
            Q.append(f)
            #R.append(flag)
            
# Feature selection by removing zero-importance features
def featureSelection():
    with open("dynamic_analysis_features","rb") as file:
        data = pickle.load(file)
        X = data[0]
        Y = data[1]
        Q = data[2]
        R = data[3]

    with open('csv_dynamic.csv',mode='w',newline='') as file:
        f = csv.writer(file)
        f.writerow(all_features)
        for i in range(0,len(X)): 
            L = X[i]
            L.extend(Q[i])
            L.append(Y[i])
            f.writerow(L)
        
    train = pd.read_csv('csv_dynamic.csv')
    train_labels = train['TARGET']
    train.head()
    train = train.drop(columns = ['TARGET'])
    fs = FeatureSelector(data = train, labels = train_labels)
    fs.identify_zero_importance(task = 'classification', eval_metric = 'auc', 
                                n_iterations = 10, early_stopping = True)
    zero_importance_features = fs.ops['zero_importance']
    print(zero_importance_features)
    
def diff(l1, l2): 
    l3 = [i for i in l1 + l2 if i not in l1 or i not in l2] 
    return l3 

def saveFeatures():
    with open("dynamic_analysis_features_updated","wb") as file:
        pickle.dump([X,Y,Q,R],file)
        
def loadFeatures():
    with open("dynamic_analysis_features_updated","rb") as file:
        data = pickle.load(file)
        X = data[0]
        Y = data[1]
        Q = data[2]
        R = data[3]
        return X,Y,Q,R
    
def randomForest(M,N):
    rclf = RandomForestClassifier(n_estimators=200,max_depth=2,random_state=0)
    rclf = rclf.fit(M,N)
    N_pred = rclf.predict(M)
    print ("Accuracy using Random Forest: ", accuracy_score(N,N_pred)*100) 
    pickle.dump(rclf,open("model", "wb" )) 
    
def applyModel():
    M = np.column_stack((X,Q))
    eclf = pickle.load(open("model","rb"))
    N = eclf.predict(M)
    with open('dynamic.csv',mode='w',newline='') as file:
        f = csv.writer(file)
        f.writerow(['File_Hash','Predicted Label'])
        for i in range(0,len(N)): 
            if(N[i]==1):
                label = 'M'
            else:
                label = 'B'
            f.writerow([filename[i],label])
    print("PREDICTION COMPLETE.")
    
if __name__ == "__main__":
    #TRAINING
    #1) Initial settings
    # owd=os.getcwd()

    #2) Extracting features from json including number of apis called (category wise)
    # featureExtraction("Benign",0)
    # featureExtraction("Malware",1)

    #3) Extracting counts of each api
    # apiCountExtraction("Benign",0)
    # apiCountExtraction("Malware",1)
    # os.chdir(owd)
    # saveFeatures()
    
    #4) Selecting features by eliminating zero-importance features
    # featureSelection()
    # unique_apis = diff(unique_apis_i,waste_apis) #count = 18

    #5) Preparing Model (Random Forest)
     #X,Y,Q,R = loadFeatures()
     #M = np.column_stack((X,Q))
     #randomForest(M,Y)
    
    #6) Applying K-fold
    # M = np.array(M)
    # N = np.array(N)
    # kf = KFold(n_splits=5)
    # kf.get_n_splits(M)
    # KFold(n_splits=5, random_state=None, shuffle=False)
    # for train_index, test_index in kf.split(M):
    #     M_train, M_test = M[train_index], M[test_index]
    #     N_train, N_test = N[train_index], N[test_index]
    #Applying Test and Split
    # M_train, M_test, N_train, N_test = train_test_split(M, N, test_size = 0.25, random_state = 100)
    
    #TESTING
    #7) Applying Model
    owd=os.getcwd()
    os.chdir(sys.argv[1])
    featureExtraction()
    apiCountExtraction()
    os.chdir(owd)
    applyModel()




